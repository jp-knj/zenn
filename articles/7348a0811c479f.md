---
title: "useState ã¨ localStorage ã§æ°¸ç¶šåŒ–ã™ã‚‹æ–¹æ³•"
emoji: "ğŸ—‚ï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['react','typescript','localstorage']
published: true 
---
## ã¯ã˜ã‚ã«
`useState`ã¯ React ã®åŸºæœ¬çš„ãª Hook API ã®ä¸€ã¤ã§ã¯ã‚ã‚Šã¾ã™ãŒã€`useState` ã§ã¯çŠ¶æ…‹ã‚’æ°¸ç¶šçš„ã«ä¿æŒã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€ãã®çŠ¶æ…‹ã¯æ¶ˆãˆã¦ã—ã¾ã„ã¾ã™ã€‚ã§ã¯ã€React ã§ãƒ‡ãƒ¼ã‚¿ã‚„çŠ¶æ…‹ã‚’æ°¸ç¶šçš„ã«ä¿æŒã™ã‚‹ã«ã¯ã©ã†ã™ã‚Œã°ã„ã„ã®ã§ã—ã‚‡ã†ã‹ã€‚çŠ¶æ…‹ã‚’æ°¸ç¶šåŒ–ã™ã‚‹ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã‚’æ›¸ã‘ã°è§£æ±ºã§ããã†ã§ã™ã€‚

## æƒ³å®šèª­è€…
- React, localStorage ã®åŸºç¤çŸ¥è­˜ã‚’ä¿æœ‰ã—ã¦ã„ã‚‹æ–¹
- useState ã¨ localStorage ã§çŠ¶æ…‹ç®¡ç†ã‚’çŸ¥ã‚ŠãŸã„æ–¹
- Recoil, Jotai ãªã©çŠ¶æ…‹ç®¡ç†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ä½¿ç”¨ã‚’æ§ãˆãŸã„æ–¹

## çµè«–
- å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰
@[codesandbox](https://codesandbox.io/embed/usepersiststate-iuj52v?fontsize=14&hidenavigation=1&theme=dark)

```typescript
import { useCallback, useState } from "react";

type Props<T> = {
    key: string;
    initialValue: T;
};

type Result<T> = readonly [T, (v: T) => void];

export const usePersistState = <T>({ key, initialValue}: Props<T>): Result<T> => {
  const getItemFromStorage = <T>(key: string, defaultValue?: T) => {
    try {
      const val = JSON.parse(localStorage.getItem(key) + "");
      if (val !== null) {
        return val;
      }
      return localStorage.setItem(key, JSON.stringify(defaultValue));
    } catch {
      return defaultValue;
    }
  };

  const [state, setState] = useState<T>(getItemFromStorage<T>(key, initialValue));

  const setValue = useCallback(
    (value: T) => {
      localStorage.setItem(key, JSON.stringify(value));
      setState(value);
    }, 
    [key]
  );

  return [state, setValue] as const;
};
```
`usePersistState`ã®ä½¿ç”¨ä¾‹
```typescript
//  ãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–ã®å ´åˆ
const [value, setValue] = usePersistState<string>({
  key: "key1",
  initialValue: "Hello World"
});

// é…åˆ—ã®å ´åˆ
const [fruits, setFruits] = usePersistState<string[]>({
 key: "key2",
 initialValue: ["apple", "banana", "orange"] 
});

// ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆ 
const initialValue = {
 name: "kenji",
 content: "Hello, using usePersistState"
}
const [user, setUser] = usePersistState<typeof initialValue>({
  key: "key3",
  initialValue: initialValue 
});
```
ä»¥é™ã¯å®Ÿè£…ã®è§£èª¬ã«ãªã‚Šã¾ã™ã€‚

## è§£èª¬ 
React ã‚„ TypeScript ã«æ…£ã‚Œã¦ã„ãªã„æ–¹ãŒè¦‹ã‚‹ã¨ã€æ··ä¹±ã—ã¦ã—ã¾ã†ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
ã“ã® `usePersistState()` ã¯ãƒ‡ãƒ¼ã‚¿ã€çŠ¶æ…‹ã‚’ localStorage ã«ä¿å­˜ã—ã€å¿…è¦ãªã¨ãã«ãƒ‡ãƒ¼ã‚¿ã€çŠ¶æ…‹ã‚’æ¸¡ã—ã¾ã™ã€‚

ç†è§£ã‚’æ·±ã‚ã‚‹ãŸã‚ã«é †ã‚’è¿½ã£ã¦è§£èª¬ã—ã¦ã„ãã¾ã™ã€‚

### ãƒ‡ãƒ¼ã‚¿ã€çŠ¶æ…‹ã‚’ä¿å­˜ã™ã‚‹ 
localStorage ã«ãƒ‡ãƒ¼ã‚¿ã€çŠ¶æ…‹ã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã«ã€`key` ã‚’ã¤ã‘ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚ä»–ã«ã‚‚ `useState`ã¨åŒæ§˜ã«ã€`initialValue`(åˆæœŸå€¤) ã‚’æ¸¡ã—ãŸã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚`useState`ã®ã¨ãã¨åŒã˜ã‚ˆã†ã«ã€ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã€çŠ¶æ…‹ã®å‹ã‚‚æ¸¡ã—ãŸã„ã§ã™ã€‚ã“ã‚Œã‚’å®Ÿç¾ã™ã‚‹ã«ã¯ã€`T`(ã‚¸ã‚§ãƒãƒªãƒƒã‚¯ã‚¹)ã‚’ä½¿ã„ã¾ã—ã‚‡ã†ã€‚

```typescript
type Props<T> = { 
 key: string; 
 initialValue: T;
}

export const usePersistStore = ({ key, initialValue }: Props<T>) => {
  const setValue = (value: T) => {};
};
```
#### useState ã‚’è¿½åŠ 
```typescript
import { useState } from "react";

type Props<T> = { 
 key: string; 
 initialValue: T;
}

export const usePersistStore = ({ key, initialValue }: Props<T>) => {
 const setValue = (value: T) => {};
 const [state, setState] = useState<T>(initialValue);
}
```
ãƒ‡ãƒ¼ã‚¿ã€çŠ¶æ…‹ã‚’ä¿å­˜ã™ã‚‹`setValue`ã‚’è¿½åŠ ã—ã¾ã™ã€‚localStorage ã‚„`useState`ã«ã‚‚ãƒ‡ãƒ¼ã‚¿ã€çŠ¶æ…‹ã‚’ä¿å­˜ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚ãã†ã™ã‚Œã°ã€`usePersistState` ã®æˆ»ã‚Šå€¤ã¨ã—ã¦`value`ã‚’æ¸¡ã™ãŸã‚ã« localStorage ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã€çŠ¶æ…‹ã‚’å–å¾—ã™ã‚‹å¿…è¦ãŒãªããªã‚Šã¾ã™ã€‚
```typescript
const setValue = (value: T) => {
 localStorage.setItem(name, JSON.stringify(value));
 setState(value);
};
```
æ³¨æ„ç‚¹ãŒã‚ã‚Šã¾ã™ã€‚`setValue`ã¯`useCallback`ã®ä¸­ã§ãƒ©ãƒƒãƒ—ã—ãªã„ã¨ã€ç„¡é™ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ«ãƒ¼ãƒ—ã®å•é¡ŒãŒç™ºç”Ÿã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚React ã¯`setValue`ãŒå¤‰æ›´ã•ã‚Œã‚‹ã‹ã©ã†ã‹ã‚’çŸ¥ã‚Šã¾ã›ã‚“ã€‚`useEffect`ã®å†…éƒ¨ã§ã“ã®é–¢æ•°ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€ä¾å­˜é–¢ä¿‚ã®é…åˆ—ã¸ã®è¿½åŠ ã‚’çœç•¥ã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€eslintã®`react-hooks/exhaustive-deps`ã¯ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤ºã•ã›ã‚‹ã§ã—ã‚‡ã†ã€‚`useCallback`ã§ãƒ©ãƒƒãƒ—ã—ã¦ã€`key` ã‚’å¤‰æ›´ã—ãªã„ã“ã¨ãŒã‚ã‹ã£ã¦ã„ã‚‹å ´åˆã§ã‚‚ã€`key` ã® dependencies(ä¾å­˜)ã‚’æ¸¡ã—ã¦ã„ã¾ã™ã€‚
```typescript
const setValue = useCallback(
 (value: T) => {
   localStorage.setItem(key, JSON.stringify(value));
   setState(value);
 }, 
 [key]
);
```
useCallback ã«ã¤ã„ã¦
https://beta.reactjs.org/reference/react/useCallback

`react-hooks/exhaustive-deps`ã«ã¤ã„ã¦
https://github.com/facebook/react/issues/14920

## ãƒ‡ãƒ¼ã‚¿ã€çŠ¶æ…‹ã‚’å–å¾—ã™ã‚‹
```typescript
const getItemFromStorage = () => {
  try {
    const val = JSON.parse(localStorage.getItem(key) + "");
    if (val !== null) {
      return val;
    }
    return localStorage.setItem(key, JSON.stringify(initialValue));
 } catch {
   return initialValue;
 }
};
```
åŸºæœ¬çš„ã«ã¯ã€localStorage ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã€çŠ¶æ…‹ã‚’å–å¾—ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã€çŠ¶æ…‹ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã€localStorage ã«ä¿å­˜ã—ã¾ã™ã€‚ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ã€ãƒ‡ãƒ¼ã‚¿ãŒ parse ã§ããªã„å ´åˆã«å‚™ãˆã¦ã€try-catch ãƒ–ãƒ­ãƒƒã‚¯ã®ä¸­ã§ãƒ©ãƒƒãƒ—ã•ã‚Œã¦ã„ã¾ã™ã€‚

## å®Œæˆ
å¼•æ•°ã‚„æˆ»ã‚Šå€¤ã®å‹ã‚’è¿½åŠ ã—ã¦ã€React ãŒ useState ã§è¡Œã£ã¦ã„ã‚‹ã‚ˆã†ã«ã€value ã¨ set ã®é–¢æ•°ã‚’æˆ»ã‚Šå€¤ã«æ¸¡ã—ã¾ã™ã€‚
```typescript
return [state, setValue] as const;
```

```typescript
import { useCallback, useState } from "react";

type Props<T> = {
  key: string;
  initialValue: T;
};

type Result<T> = readonly [T, (v: T) => void];

export const usePersistState = <T>({ key, initialValue}: Props<T>): Result<T> => {

  // çœç•¥

  const [state, setState] = useState<T>(getItemFromStorage<T>(key, initialValue));
  
  // çœç•¥
    
  return [state, setValue] as const;
};
```

Develop Tool ã§æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹ã‹ã€ç¢ºèªã—ã¦å®Œäº†ã§ã™ã€‚
ä¸‹è¨˜ã¯ã€CodeSandbox ã® ãƒ‡ãƒ¢ã‚’å®Ÿè¡Œã—ãŸçµæœã«ãªã‚Šã¾ã™ã€‚
![](/images/usePersistState2.png)
![](/images/usePersistState.png)

### å‚è€ƒ
https://react-typescript-cheatsheet.netlify.app/docs/basic/useful-hooks#uselocalstorage

## æœ€å¾Œã«
åŸºæœ¬çš„ãª localStorage ã®å‡¦ç†ã‚’æ›¸ã„ã¦ã„ãã¾ã—ãŸãŒã€ã‚‚ã—ã‚‚ Web Storage API ã‚’ä½¿ç”¨ã™ã‚‹æ™‚ã¯ã€ãƒ¦ãƒ¼ã‚¶ãŒ localStorage ã‚’[ä½¿ãˆã‚‹ã‹ã©ã†ã‹ ](https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API/Using_the_Web_Storage_API#testing_for_availability)ã‚’ç¢ºèªã™ã‚‹ã‚ˆã†ã«ã™ã‚‹ã®ã‚‚è‰¯ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

ã‚‚ã—ã€é–“é•ã£ãŸçŸ¥è­˜ã‚„å†…å®¹ãŒã‚ã‚Šã¾ã—ãŸã‚‰ã€ã”æŒ‡æ‘˜ãã ã•ã„

