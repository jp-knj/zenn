---
title: "useState ã¨ localStorage ã§æ°¸ç¶šçš„ãªçŠ¶æ…‹ã‚’ä¿å­˜ã™ã‚‹æ–¹æ³•"
emoji: "ğŸ’¨"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['react','typescript','localstorage']
published: false
---
## ã¯ã˜ã‚ã«
`useState`ã¯ React ã®åŸºæœ¬çš„ãª Hook API ã®ä¸€ã¤ã§ã¯ã‚ã‚Šã¾ã™ãŒã€`useState` ã§ã¯çŠ¶æ…‹ã‚’æ°¸ç¶šçš„ã«ä¿æŒã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€ãã®çŠ¶æ…‹ã¯æ¶ˆãˆã¦ã—ã¾ã„ã¾ã™ã€‚ã§ã¯ã€React ã§ãƒ‡ãƒ¼ã‚¿ã‚„çŠ¶æ…‹ã‚’æ°¸ç¶šçš„ã«ä¿æŒã™ã‚‹ã«ã¯ã©ã†ã™ã‚Œã°ã„ã„ã®ã§ã—ã‚‡ã†ã‹ã€‚çŠ¶æ…‹ã‚’æ°¸ç¶šåŒ–ã™ã‚‹ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã‚’æ›¸ã‘ã°è§£æ±ºã§ããã†ã§ã™ã€‚

## æƒ³å®šèª­è€…
- React, localStorage ã®åŸºç¤çŸ¥è­˜ã‚’ä¿æœ‰ã—ã¦ã„ã‚‹æ–¹
- useState ã¨ localStorage ã§çŠ¶æ…‹ç®¡ç†ã‚’çŸ¥ã‚ŠãŸã„æ–¹
- Recoil, Jotai ãªã©çŠ¶æ…‹ç®¡ç†ã‚’æ¥µåŠ›ä½¿ç”¨ã‚’æ§ãˆãŸã„æ–¹

## è¦ç´„
- å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰

@[codesandbox](https://codesandbox.io/embed/usepersiststate-iuj52v?fontsize=14&hidenavigation=1&theme=dark)

```typescript
import { useCallback, useState } from "react";

type Props<T> = {
    key: string;
    initialValue: T;
};

type Result<T> = readonly [T, (v: T) => void];

export const usePersistState = <T>({ key, initialValue}: Props<T>): Result<T> => {
  const getItemFromStorage = <T>(key: string, defaultValue?: T) => {
    try {
      const val = JSON.parse(localStorage.getItem(key) + "");
      if (val !== null) {
        return val;
      }
      return localStorage.setItem(key, JSON.stringify(defaultValue));
    } catch {
      return defaultValue;
    }
  };

  const [state, setState] = useState<T>(getItemFromStorage<T>(key, initialValue));

  const setValue = useCallback(
    (value: T) => {
      localStorage.setItem(key, JSON.stringify(value));
      setState(value);
    }, 
    [key]
  );

  return [state, setValue] as const;
};
```
`usePersistState`ã®ä½¿ç”¨ä¾‹
```typescript
//  ãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–ã®å ´åˆ
const [value, setValue] = usePersistState<string>({
  key: "key1",
  initialValue: "Hello World"
});

// é…åˆ—ã®å ´åˆ
const [fruits, setFruits] = usePersistState<string[]>({
 key: "key2",
 initialValue: ["apple", "banana", "orange"] 
});

// ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆ 
const initialValue = {
  id: 1,
  name: "kenji"  
}
const [user, setUser] = usePersistState<typeof initialValue>({
  key: "key3",
  initialValue: initialValue 
});
```

## è§£èª¬ 
React ã‚„ TypeScript ã«æ…£ã‚Œã¦ã„ãªã„æ–¹ãŒè¦‹ã‚‹ã¨ã€æ··ä¹±ã—ã¦ã—ã¾ã†ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
ã“ã® `usePersistState()` ã¯çŠ¶æ…‹ã‚’ localStorage ã«ä¿å­˜ã—ã€å¿…è¦ãªã¨ãã«çŠ¶æ…‹ã‚’æ¸¡ã—ã¾ã™ã€‚

ç†è§£ã‚’æ·±ã‚ã‚‹ãŸã‚ã«é †ã‚’è¿½ã£ã¦è§£èª¬ã—ã¦ã„ãã¾ã™ã€‚

### çŠ¶æ…‹ã‚„ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹ 
localStorage ã«ãƒ‡ãƒ¼ã‚¿ã€çŠ¶æ…‹ã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã«ã€`key` ã‚’ã¤ã‘ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚ä»–ã«ã‚‚ `useState`ã¨åŒæ§˜ã«ã€`initialValue`(åˆæœŸå€¤) ã‚’æ¸¡ã—ãŸã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
`useState`ã®ã¨ãã¨åŒã˜ã‚ˆã†ã«ã€ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã€çŠ¶æ…‹ã®å‹ã‚‚æ¸¡ã—ãŸã„ã§ã™ã€‚ã“ã‚Œã‚’å®Ÿç¾ã™ã‚‹ã«ã¯ã€`T`(ã‚¸ã‚§ãƒãƒªãƒƒã‚¯ã‚¹)ã‚’ä½¿ã„ã¾ã—ã‚‡ã†ã€‚

```typescript
type Props<T> = {
	key: string;
	initialValue: T;
}

export const usePersistStore = ({ key, initialValue }: Props<T>) => {
	const setValue = (value: T) => {};
};
```
#### useState ã‚’è¿½åŠ 
```typescript
import { useState } from "react";

type Props<T> = {
	key: string;
	initialValue: T;
}

export const usePersistStore = ({ key, initialValue }: Props<T>) => {
	const setValue = (value: T) => {};
    const [state, setState] = useState<T>(initialValue);
}
```
ãƒ‡ãƒ¼ã‚¿ã€çŠ¶æ…‹ã‚’ä¿å­˜ã™ã‚‹ `setValue`  ã‚’è¿½åŠ ã—ã¾ã™ã€‚localStorage ã‚„`useState`ã«ã‚‚ãƒ‡ãƒ¼ã‚¿ã€çŠ¶æ…‹ã‚’ä¿å­˜ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚ãã†ã™ã‚Œã°ã€`value` ã‚’è¿”ã™ãŸã‚ã« localStorage ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã€çŠ¶æ…‹ã‚’ã€€å–å¾—ã™ã‚‹å¿…è¦ãŒãªããªã‚Šã¾ã™ã€‚
```typescript
const setValue = (value: T) => {
    localStorage.setItem(name, JSON.stringify(value));
    setState(value);
};
```
ã¨ã¦ã‚‚ç°¡å˜ã§ã—ã‚‡ã†ï¼Ÿã—ã‹ã—ã€ã“ã‚Œã‚’useCallbackã®ä¸­ã§ãƒ©ãƒƒãƒ—ã—ãªã„ã¨ã€ç„¡é™ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ«ãƒ¼ãƒ—ã®å•é¡ŒãŒç™ºç”Ÿã™ã‚‹ã€‚Reactã¯setValueé–¢æ•°ãŒå¤‰æ›´ã•ã‚Œã‚‹ã‹ã©ã†ã‹ã‚’çŸ¥ã‚‰ãªã„ã€‚ã—ã‹ã—ã€ç§ãŸã¡ã¯çŸ¥ã£ã¦ã„ã‚‹ã€‚useEffectã®å†…éƒ¨ã§ã“ã®é–¢æ•°ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€ä¾å­˜é–¢ä¿‚ã®é…åˆ—ã¸ã®è¿½åŠ ã‚’çœç•¥ã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€eslintã¯ç§ãŸã¡ã‚’æ‚©ã¾ã™ã§ã—ã‚‡ã†ã€‚
https://beta.reactjs.org/reference/react/useCallback
https://github.com/facebook/react/issues/14920
ã“ã‚Œã‚’useCallbackãƒ•ãƒƒã‚¯ã®ä¸­ã§ãƒ©ãƒƒãƒ—ã—ã¦ã€åå‰ã‚’å¤‰æ›´ã—ãªã„ã“ã¨ãŒã‚ã‹ã£ã¦ã„ã‚‹å ´åˆã§ã‚‚ã€åå‰ã®ä¾å­˜æ€§ã‚’æ¸¡ã—ã¦ã¿ã‚ˆã†ã€‚
```typescript
const setValue = useCallback(
	(value: T) => {
		localStorage.setItem(key, JSON.stringify(value));
		setState(value);
	},
	[key]
);
```

## 
```typescript
const getFromStorage = () => {
    try {
        const val = JSON.parse(localStorage.getItem(key) + "");
        if (val !== null) {
            return val;
        }
        return localStorage.setItem(key, JSON.stringify(initialValue));
    } catch {
        return initialValue;
    }
};
```
åŸºæœ¬çš„ã«ã¯ã€localStorageã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã€localStorageã«ä¿å­˜ã™ã‚‹ã€‚ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ã€ãƒ‡ãƒ¼ã‚¿ãŒè§£æã§ããªã„å ´åˆã«å‚™ãˆã¦ã€try-catchãƒ–ãƒ­ãƒƒã‚¯ã®ä¸­ã§ãƒ©ãƒƒãƒ—ã•ã‚Œã¦ã„ã¾ã™ã€‚ã‚‚ã—ãã†ãªã‚‰ã€ã‚³ãƒ¼ãƒ‰ã¯initialValueã‚’è¿”ã—ã¾ã™ã€‚

## ã‚³ãƒ¼ãƒ‰ã‚’å®Œæˆã•ã›ã¾ã—ã‚‡ã†

getFromStorageé–¢æ•°ã‚’useStateã®ä¸Šã«é…ç½®ã™ã‚‹ã€‚getFromStorage()é–¢æ•°ã®å‘¼ã³å‡ºã—ã‚’useStateã«æ¸¡ã™ã«ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚

ã§ã¯ã€ReactãŒuseStateã§è¡Œã£ã¦ã„ã‚‹ã‚ˆã†ã«ã€setã¨getã®é–¢æ•°ã‚’è¿”ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
```typescript
return [state, setValue] as const;
```

```typescript
import { useCallback, useState } from "react";

type Props<T> = {
	key: string;
	initialValue: T;
}

export const usePersistStore = ({ key, initialValue }: Props<T>): readonly [T, (v: T) => void] => {
	const getFromStorage = <T>(key: string, defaultValue?: T) => {
		try {
			const val = JSON.parse(localStorage.getItem(key) + "");
			if (val !== null) {
				return val;
			}
            return localStorage.setItem(key, JSON.stringify(defaultValue));
		} catch {
			return defaultValue;
		}
	};

	const [state, setState] = useState<T>(getFromStorage<T>(key, initialValue));

	const setValue = useCallback(
		(value: T) => {
			localStorage.setItem(key, JSON.stringify(value));
			setState(value);
		},
		[key]
	);

	return [state, setValue] as const;
};
```

You can verify it working by checking your developer console. You might also want to delete the entry in your localStorage.

## æœ€å¾Œã«
"ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§å‡¦ç†ã™ã‚Œã°ã„ã„ã®ã§ã¯ï¼Ÿ"ã¨ã€‚ã‚‚ã¡ã‚ã‚“ã€ã§ãã¾ã™ã€‚ã—ã‹ã—ã€ç§ã¯ã‹ãªã‚ŠåŸºæœ¬çš„ãªå•é¡Œã‚’è§£æ±ºã™ã‚‹æ–¹æ³•ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’æä¾›ã—ãŸã‹ã£ãŸã®ã§ã™ã€‚ç§ã¯ã€è‡ªåˆ†ãŒä½¿ã£ã¦ã„ã‚‹è§£æ±ºç­–ã‚’ç†è§£ã™ã‚‹æ–¹ãŒå¥½ããªã®ã§ã™ã€‚

ã€Œã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å†…éƒ¨ã§ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚Šã€ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å–å¾—ã—ãŸã‚Šã™ã‚‹ã®ã¯ã©ã†ã§ã—ã‚‡ã†ã‹?ãã‚Œã¯ã†ã¾ãã„ãã¯ãšã§ã™ãŒã€ç§ã¯ã‚ˆã‚Šã‚¨ãƒ¬ã‚¬ãƒ³ãƒˆãªè§£æ±ºç­–ã‚’å–ã‚ŠãŸã‹ã£ãŸã®ã§ã™ã€‚