---
title: "React + D3 ã§ Pie ã‚’æã"
emoji: "ğŸ¥"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [javascript, react, d3js, å¯è¦–åŒ–]
published: true
---
# ã¯ã˜ã‚ã«
å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚„æŠ€è¡“æ›¸ã§ã‚¤ãƒ³ãƒ—ãƒƒãƒˆã—ãŸå†…å®¹ã‚’ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆã¨ã—ã¦è¨˜äº‹ã‚’ä½œæˆã•ã›ã¦ã‚‚ã‚‰ã„ã¾ã—ãŸã€‚ã‚‚ã—ã€ä¸é©åˆ‡ãªç®‡æ‰€ãŒã‚ã‚Œã°ã”æŒ‡æ‘˜ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ã€‚

## æœ€çµ‚çš„ãªæˆæœç‰©
ã“ã¡ã‚‰ãŒæˆæœç‰©ã«ãªã‚Šã¾ã™ã€‚
![f6ab435be017c354ed270db3a11c7d47](https://user-images.githubusercontent.com/70939128/114299412-fa2f4900-9af5-11eb-9f35-8c87954735ae.gif)

:::details Pieã‚°ãƒ©ãƒ•ã®ã‚³ãƒ¼ãƒ‰
```javascript:Pie.js
import React, { useEffect, useRef } from "react";
import * as d3 from "d3";

const Pie = props => {
  const ref = useRef(null);
  const cache = useRef(props.data);
  const createPie = d3
    .pie()
    .value(d => d.value)
    .sort(null);
  const createArc = d3
    .arc()
    .innerRadius(props.innerRadius)
    .outerRadius(props.outerRadius);
  const colors = d3.scaleOrdinal(d3.schemeCategory10);
  const format = d3.format(".2f");

  useEffect(
    () => {
      const data = createPie(props.data);
      const prevData = createPie(cache.current);
      const group = d3.select(ref.current);
      const groupWithData = group.selectAll("g.arc").data(data);

      groupWithData.exit().remove();

      const groupWithUpdate = groupWithData
        .enter()
        .append("g")
        .attr("class", "arc");

      const path = groupWithUpdate
        .append("path")
        .merge(groupWithData.select("path.arc"));

      const arcTween = (d, i) => {
        const interpolator = d3.interpolate(prevData[i], d);

        return t => createArc(interpolator(t));
      };

      path
        .attr("class", "arc")
        .attr("fill", (d, i) => colors(i))
        .transition()
        .attrTween("d", arcTween);

      const text = groupWithUpdate
        .append("text")
        .merge(groupWithData.select("text"));

      text
        .attr("text-anchor", "middle")
        .attr("alignment-baseline", "middle")
        .style("fill", "white")
        .style("font-size", 10)
        .transition()
        .attr("transform", d => `translate(${createArc.centroid(d)})`)
        .tween("text", (d, i, nodes) => {
          const interpolator = d3.interpolate(prevData[i], d);

          return t => d3.select(nodes[i]).text(format(interpolator(t).value));
        });

      cache.current = props.data;
    },
    [props.data]
  );

  return (
    <svg width={props.width} height={props.height}>
      <g
        ref={ref}
        transform={`translate(${props.outerRadius} ${props.outerRadius})`}
      />
    </svg>
  );
};

export default Pie;
```
:::

:::details index.jsã®ã‚³ãƒ¼ãƒ‰
```javascript:index.js
import React, { useState } from "react";
import ReactDOM from "react-dom";
import * as d3 from "d3";

// ä½œæˆã—ãŸPieã‚°ãƒ©ãƒ•
import Pie from "./Pie";

function App() {

  const [width, height, innerRadius, outerRadius] = [200, 200, 60, 100];

  // ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ™‚ã€ãƒ©ãƒ³ãƒ€ãƒ ãªãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã™ã‚‹
  const generateData = (value, length = 5) =>
    d3.range(length).map((item, index) => ({
      date: index,
      value: value === null || value === undefined ? Math.random() * 100 : value
    }));
  const [data, setData] = useState(generateData());
  const changeData = () => {
    setData(generateData());
  };

  return (
    <div className="App">
      <div>
        <button onClick={changeData}>Click</button>
      </div>
      <div>
        <h2 className="label">React Hook</h2>
        <Pie
          data={data}
          width={width}
          height={height}
          innerRadius={innerRadius}
          outerRadius={outerRadius}
        />
      </div>
    </div>
  );
}

const rootElement = document.getElementById("root");
ReactDOM.render(<App />, rootElement);
```
:::

## ã‚³ãƒ¼ãƒ‰ã®è§£èª¬

ã§ã¯æ—©é€Ÿã€ã‚³ãƒ¼ãƒ‰ã®å†…å®¹ã‚’èª¬æ˜ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚

## Pieã‚°ãƒ©ãƒ•ã®è¨­å®šã‚’æ›¸ã
```javascript:script.js
ã€€// useRefã‚’è¨­å®šã—ã¾ã™
  const ref = useRef(null);
  const cache = useRef(props.data);

  // d3.pieã§ å††å¼§ã®å§‹ç‚¹/çµ‚ç‚¹è¨ˆç®—ã‚’è¨­å®šã—ã¾ã™
  const createPie = d3
    .pie()
    .value(d => d.value)
    .sort(null);

  // d3.arcã§ å††å¼§ã®å¤–å´ã®åŠå¾„ã€å†…å´ã®åŠå¾„ã‚’è¨­å®šã—ã¾ã™
  const createArc = d3
    .arc()
    .innerRadius(props.innerRadius)
    .outerRadius(props.outerRadius);

  // é …ç›®ã®è‰²ã‚’è¨­å®šã—ã¾ã™
  const colors = d3.scaleOrdinal(d3.schemeCategory10);

  // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’è¨­å®šã—ã¾ã™
  const format = d3.format(".2f");
```

"useRef" ã¯ ç®±ã¨ã„ã†èªè­˜ã§ã™ã€‚ã¶ã£ã¡ã‚ƒã‘ã€é›°å›²æ°—ã§ä½¿ã£ã¦ã¾ã™...

ä½™è«‡ã¯ã•ã¦ãŠãã€
- d3.pie() ã«Pieã‚°ãƒ©ãƒ•ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆã™ã‚‹ã€‚
- svg ã® path ã‚’ä½œæˆã—ã¦ã€Pieã‚°ãƒ©ãƒ• ã®å††å¼§ã‚’æç”»ã—ã¾ã™
- Pieã‚°ãƒ©ãƒ• ã®å†…å´ã«ã‚ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’æŒ‡å®šã—ã¾ã™

## Pieã‚°ãƒ©ãƒ•ã®ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚’æ›¸ã
```javascript:script.js
useEffect(
    () => {
      const data = createPie(props.data);
      const prevData = createPie(cache.current);
      const group = d3.select(ref.current);

      // å„å††å¼§ã« data ã‚’ã‚»ãƒƒãƒˆã—ã¾ã™
      const groupWithData = group.selectAll("g.arc").data(data);

      // ä¸è¦ãªè¦ç´ ã‚’å‰Šé™¤ã—ã¾ã™
      groupWithData.exit().remove();

      // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆã•ã‚ŒãŸæ–°ã—ã„ element ã«ãƒã‚¤ãƒ³ãƒ‰ã™ã‚‹
      const groupWithUpdate = groupWithData
        .enter()
        .append("g")ã€€// group container ã‚’è¿½åŠ ã™ã‚‹
        .attr("class", "arc");

      const path = groupWithUpdate
        .append("path") // path ã‚’è¿½åŠ ã™ã‚‹
        .merge(groupWithData.select("path.arc"));ã€€// merge() ã¯ã€€enter() ã¨ update()ã‚’çµ„ã¿åˆã‚ã›ãŸé–¢æ•°

      const arcTween = (d, i) => {
        const interpolator = d3.interpolate(prevData[i], d);

        return t => createArc(interpolator(t));
      };

      // Pieã‚°ãƒ©ãƒ• ã‚’ã‚ªã‚·ãƒ£ãƒ¬ã«ã™ã‚‹
      path
        .attr("class", "arc")
        .attr("fill", (d, i) => colors(i))
        .transition()
        .attrTween("d", arcTween);

      const text = groupWithUpdate
        .append("text") // text ã‚’è¿½åŠ ã™ã‚‹
        .merge(groupWithData.select("text"));

      // text ã‚’ã‚ªã‚·ãƒ£ãƒ¬ã«ã™ã‚‹
      text
        .attr("text-anchor", "middle")
        .attr("alignment-baseline", "middle")
        .style("fill", "white")
        .style("font-size", 10)
        .transition()
        .attr("transform", d => `translate(${createArc.centroid(d)})`)
        .tween("text", (d, i, nodes) => {
          const interpolator = d3.interpolate(prevData[i], d);

          return t => d3.select(nodes[i]).text(format(interpolator(t).value));
        });

      cache.current = props.data;
    },
    [props.data]
  );
```
### ä¸»ã«ã‚„ã£ã¦ã‚‹ã“ã¨ã¯ 2ã¤ ã®ã¿ã§ã™
- data ã‚’ã‚»ãƒƒãƒˆã—ãŸ g è¦ç´  "<g class="arc">" ã‚’ä½œæˆã—ã¾ã™ã€‚
- attr(å±æ€§)ã‚’è¿½åŠ ã—ã¦ã€è¦‹ãŸç›®ã‚’æ•´ãˆã¾ã™ã€‚

### D3ã‚’è§¦ã‚‹ä¸Šã§çŸ¥ã£ã¦æã¯ãªã„é–¢æ•°ã§ã™
- "enter()" : æ–°ã—ã„è¦ç´ ã‚’ç”Ÿæˆã™ã‚‹
- "update()" : æ—¢å­˜ã®è¦ç´ ã‚’æ›´æ–°ã™ã‚‹
- "exit()" : ä¸è¦ãªè¦ç´ ã‚’æ‰±ã†

## ãƒ‡ãƒ¼ã‚¿æç”»ã‚’æ›¸ã

```javascript:script.js
return (
    <svg width={props.width} height={props.height}>
      <g
        ref={ref}
        transform={`translate(${props.outerRadius} ${props.outerRadius})`}
      />
    </svg>
  );
```
- html ã«å¤‰æ•°ã‚’æ›¸ãè¾¼ã‚“ã ã‚‰ã€å®Œæˆã«ãªã‚Šã¾ã™ã€‚

## å®Œæˆ
![f6ab435be017c354ed270db3a11c7d47](https://user-images.githubusercontent.com/70939128/114299412-fa2f4900-9af5-11eb-9f35-8c87954735ae.gif)


## ãŠã‚ã‚Šã«
èª­ã‚“ã§é ‚ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ãƒœã‚¯è‡ªèº«ã€ JavaScript ã§ãƒ‡ãƒ¼ã‚¿å¯è¦–åŒ–ã™ã‚‹ã®ã¯æ¥½ã—ã„ãªå®Ÿæ„Ÿã—å§‹ã‚ãŸã°ã‹ã‚Šã§ã™ã€‚ä»Šåº¦ã¯ã‚ˆã‚Šåˆ†ã‹ã‚Šã‚„ã™ãã€ã‚ˆã‚Šã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã§ãƒ‡ã‚¶ã‚¤ãƒ³ã‚‚è‰¯ã„ãƒ‡ãƒ¼ã‚¿å¯è¦–åŒ–ã§ãã‚‹ã‚ˆã†ã«ç²¾é€²ã•ã›ã¦ã„ãŸã ãã¾ã™ï¼
